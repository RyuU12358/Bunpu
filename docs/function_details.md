# Bunpu 関数詳細リファレンス

各関数の詳細な処理内容と使用例を説明します。

---

## 1. 分布生成関数

### CONST(x)

**定数分布を作成**

単一の値 x を確率 1 で返す分布（スカラー値）を作成します。

```
=CONST(100)     // 常に100を返す
=CONST(-50)     // 常に-50を返す
```

**内部処理:**

- `{ type: "atom", x: 値, p: 1 }` のコンポーネントを 1 つ持つ分布を生成

---

### UNIFORM(min, max)

**一様分布を生成**

min から max の間で等確率の連続分布を生成します。

```
=UNIFORM(0, 100)    // 0〜100の一様分布
=UNIFORM(-10, 10)   // -10〜10の一様分布
```

**制約:**

- `min < max` でなければエラー

**内部処理:**

- 単一の bin（区間）コンポーネントとして表現
- 代表値(repr)は区間の中央値

---

### NORMAL(mean, std)

**正規分布を生成**

指定された平均と標準偏差を持つ正規分布を生成します。

```
=NORMAL(0, 1)       // 標準正規分布
=NORMAL(100, 15)    // 平均100、標準偏差15
```

**制約:**

- `std > 0` でなければエラー

**内部処理:**

- mean ± 4σ の範囲を 20 個のビンに分割して近似
- 各ビンの確率は PDF の台形近似で計算
- 最後に正規化して確率の合計を 1 にする

---

### DISCRETE(v1, p1, v2, p2, ...)

**離散確率分布を生成**

値と確率のペアを指定して離散分布を作成します。

```
=DISCRETE(0, 0.5, 100, 0.5)           // 50%で0、50%で100
=DISCRETE(1000, 0.2, 600, 0.2, 300, 0.6)  // パチンコ出玉振り分け
```

**制約:**

- 引数は偶数個（値と確率のペア）
- 確率は 0 以上
- 確率の合計が 0 でないこと（自動正規化される）

**内部処理:**

- 各ペアを atom コンポーネントに変換
- 確率の合計で正規化

---

### CHOICE(v1, w1, v2, w2, ...)

**重み付き選択分布**

DISCRETE と同様ですが、重みを確率に自動変換します。

```
=CHOICE(100, 3, 200, 1)   // 3:1の比率 = 75%:25%
```

**内部処理:**

- 各重みを合計で割って確率に変換
- 最後に正規化

---

### EXPONENTIAL(rate)

**指数分布を生成**

レート(λ)を持つ指数分布を生成します。平均は 1/λ です。

```
=EXPONENTIAL(0.01)   // 平均100（=1/0.01）の指数分布
=EXPONENTIAL(1/200)  // 平均200の指数分布
```

**内部処理:**

- CDF=0.999 までの範囲を 50 個のビンに分割
- 各ビンの確率は exp(-λa) - exp(-λb)で厳密計算

---

### POISSON(lambda)

**ポアソン分布を生成**

期待値 λ のポアソン分布（整数値の離散分布）を生成します。

```
=POISSON(5)     // 期待値5のポアソン分布（0,1,2,3,...）
=POISSON(100)   // 期待値100のポアソン分布
```

**内部処理:**

- P(0) = exp(-λ) から開始
- P(k+1) = P(k) × λ / (k+1) で反復計算
- 累積確率が 0.99999 を超えるか、コンポーネント上限に達したら終了

---

### BINOMIAL(n, p)

**二項分布を生成**

n 回のベルヌーイ試行で成功確率 p の二項分布を生成します。

```
=BINOMIAL(10, 0.5)    // 10回コイン投げ、表が出る回数の分布
=BINOMIAL(100, 0.01)  // 100回試行で1%成功の分布
```

**制約:**

- `n >= 0`
- `0 <= p <= 1`
- n がコンポーネント上限を超えるとエラー

---

## 2. 演算関数

### ADD(A, B)

**分布の加算（畳み込み）**

2 つの独立な確率変数の和の分布を計算します。

```
=ADD(CONST(100), CONST(50))         // 常に150
=ADD(NORMAL(0, 1), NORMAL(0, 1))    // N(0, √2)に近い分布
```

**内部処理:**

- 畳み込み（convolution）を実行
- 可能な場合は WASM で高速化
- 結果のコンポーネント数が上限を超えると自動縮約

---

### SUB(A, B)

**分布の減算**

A - B の分布を計算します。

```
=SUB(CONST(100), NORMAL(10, 5))     // 100 - N(10,5)
```

**内部処理:**

- B の各値を-1 倍して A に加算

---

### MUL(A, B)

**スカラー倍**

分布をスカラー倍します（分布同士の乗算は未対応）。

```
=MUL(UNIFORM(0, 10), 2)     // 0〜20の一様分布
=MUL(3, NORMAL(0, 1))       // N(0, 3)に近い
```

**制約:**

- 一方がスカラーでなければエラー

---

### DIV(A, B)

**除算**

分布をスカラーで割るか、スカラーを分布で割ります。

```
=DIV(CONST(100), 4)         // 25
=DIV(250, UNIFORM(10, 20))  // 250 / U(10,20) = U(12.5, 25)
```

**内部処理:**

- Scalar / Dist の場合は逆数分布を計算（reciprocal）

---

### SCALE(A, k)

**分布のスケーリング**

MUL の別名。分布の各値を k 倍します。

---

### SHIFT(Dist, k)

**分布のシフト**

分布の全ての値に k を加算します。

```
=SHIFT(UNIFORM(0, 100), 50)    // 50〜150の一様分布
```

---

### MIX(p, A, B)

**混合分布**

確率 p で A、確率(1-p)で B を選択する混合分布を作成します。

```
=MIX(0.3, CONST(1000), CONST(0))    // 30%で1000、70%で0
=MIX(0.5, NORMAL(0, 1), NORMAL(10, 1))  // 二峰性分布
```

**内部処理:**

- A の各コンポーネントの確率を p 倍
- B の各コンポーネントの確率を(1-p)倍
- 両方を結合

---

## 3. 繰り返し関数

### GEOM_SUM(Dist, p)

**幾何分布的繰り返しの和**

確率 p で継続する試行の合計を計算します。パチンコの RUSH 計算に最適。

```
=GEOM_SUM(CONST(1500), 0.81)    // 81%継続RUSHの出玉分布
=GEOM_SUM(DISCRETE(1000, 0.2, 300, 0.8), 0.7)  // 振り分けあり
```

**数学的定義:**

```
S = Σ_{k=0}^{∞} (1-p) × p^k × (Dist を k回加算した分布)
```

**内部処理:**

- k=0 から開始し、(1-p)×p^k の確率で k 回の畳み込み結果を加える
- 累積確率が 0.9999 を超えるか、k=2000 に達したら終了
- 各ステップでコンポーネント数を制限（checkSafety）

**平均値:**

```
E[S] = p / (1-p) × E[Dist]
```

例: p=0.7, E[Dist]=500 → E[S] = 0.7/0.3 × 500 = 1167

---

### REPEAT_ADD(Dist, N)

**固定回数の加算**

分布を N 回加算します（固定回数）。

```
=REPEAT_ADD(CONST(100), 10)     // 常に1000
=REPEAT_ADD(BINOMIAL(1, 0.5), 100)  // 100回コイン投げ
```

**内部処理:**

- バイナリ累乗法で効率的に計算
- O(log N) 回の畳み込みで完了

---

## 4. 統計関数

### MEAN(Dist)

**平均（期待値）**

```
=MEAN(NORMAL(100, 15))    // 100
=MEAN(UNIFORM(0, 100))    // 50
```

---

### VAR(Dist)

**分散**

```
=VAR(NORMAL(0, 10))    // 100 (= 10^2)
```

---

### STD(Dist)

**標準偏差**

```
=STD(NORMAL(0, 10))    // 10
```

---

### MEDIAN(Dist)

**中央値**

```
=MEDIAN(EXPONENTIAL(1))    // 約0.693 (= ln(2))
```

---

### PROB_GT(Dist, x)

**確率計算 P(X > x)**

分布が x を超える確率を計算します。

```
=PROB_GT(NORMAL(0, 1), 0)      // 0.5
=PROB_GT(UNIFORM(0, 100), 80)  // 0.2
```

---

## 5. 高度な分析関数

### RUIN_PROB(StepDist, Init, Steps)

**破産確率を計算**

1 ステップごとの収支分布、初期資金、試行回数から破産確率を計算します。

```
=RUIN_PROB(ADD(MIX(0.01, CONST(1000), CONST(0)), -14), 50000, 1000)
```

**パラメータ:**

- `StepDist`: 1 回の試行の収支（正=勝ち、負=負け）
- `Init`: 初期資金
- `Steps`: 試行回数

**内部処理:**

- Steps <= 300: 厳密な畳み込みで計算
- Steps > 300: モンテカルロシミュレーション（WASM 高速化）
  - 約 10,000〜100,000 回のシミュレーション
  - 資金が 0 以下になった回数をカウント

---

### MAX_OF(Dist, N)

**最大値分布**

N 個の独立サンプルの最大値の分布を計算します。

```
=MAX_OF(UNIFORM(0, 1), 10)    // 10個の一様乱数の最大値
```

---

## 6. ユーティリティ関数

### RESAMPLE(Dist, N)

**リサンプリング**

分布から N 点をサンプリングして新しい離散分布を作成します。

```
=RESAMPLE(NORMAL(0, 1), 100)    // 100点の離散近似
```

---

### REDUCE(Dist, targetN)

**コンポーネント削減**

分布のコンポーネント数を指定数まで減らします。

```
=REDUCE(POISSON(100), 20)    // 20コンポーネントに削減
```

---

### CONFIG(limit, expr)

**コンポーネント上限設定**

式の評価中に使用するコンポーネント上限を設定します。

```
=CONFIG(500, REPEAT_ADD(BINOMIAL(10, 0.5), 20))
```

---

## パチンコ計算の実践例

### 基本的な RUSH 計算

```
// 継続率81%、1回あたり1500発のRUSH
=ADD(CONST(1500), GEOM_SUM(CONST(1500), 0.81))
// → 初回確定 + 継続分
```

### LT 機の計算

```
// 下位RUSH + LT昇格チャンス
=ADD(
  GEOM_SUM(DISCRETE(1000, 0.2, 600, 0.2, 300, 0.6), 0.7),
  MIX(0.1, ADD(CONST(1000), GEOM_SUM(B9, 0.95)), 0)
)
```

### ボーダー計算

```
// ボーダー = 250 / (期待出玉 × 大当たり確率)
=250 / (MEAN(大当たり分布セル) * 1/99.9)
```

### 勝率計算

```
// 正規近似による勝率
=PROB_GT(NORMAL(MEAN(収支)*回転数, STD(収支)*POWER(回転数, 0.5)), 0)
```
