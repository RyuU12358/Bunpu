# 範囲選択サポートの実装計画

## 目的

`DISCRETE` や `CHOICE` などの関数で、`A1:B3` のような範囲指定を利用可能にする。
これにより、別表で定義したパラメータ（値と確率のペアなど）を簡単に関数に渡せるようにする。

## ユーザーレビューが必要な事項

- 特になし（既存機能への追加であり、破壊的変更はない予定）

## 変更内容

### `src/engine/evaluator.ts`

#### [MODIFY] [evaluator.ts](file:///c:/dev_Bunpu/Bunpu/src/engine/evaluator.ts)

1.  **トークナイザーの更新 (`tokenize`)**

    - `:` (COLON) を認識するように正規表現または switch 文を追加。
    - `TokenType` に `"COLON"` を追加。

2.  **範囲展開ヘルパーの実装 (`expandRange`)**

    - `A1` から `B3` のような範囲指定を受け取り、ID のリスト（`["A1", "B1", "A2", "B2", "A3", "B3"]`）を返す関数を実装する。
    - アルファベット（列）と数字（行）を解析し、行優先（Row-major）順序で展開する。
      - 理由: `DISCRETE(val, prob, val, prob...)` の形式に合わせるため、`A1` (val), `B1` (prob) の順で渡されるのが自然であるため。

3.  **パーサーの更新 (`Parser.parseFunctionCall`)**
    - 引数のパースループ内で、`ID` トークンの直後に `COLON` `ID` が続くパターンを検出する。
      - `parseExpression` ではなく、引数リストの解析時に特例として処理する方が安全（演算子としての `:` ではないため）。
      - `<Expr> : <Expr>` という一般的な汎用構文ではなく、`args` のパース時に `ID : ID` が来たら範囲として展開する。
    - 展開された ID リストをそれぞれ `ctx.getValue(id)` で解決し、引数リスト (`args`) にフラットに追加する。

## 検証計画

### 自動テスト

- `evaluator.mvp.test.ts` (または新規テストファイル) にテストケースを追加。
  - `tokenize` が `:` を正しくトークン化することを確認。
  - `parseFunctionCall` が `A1:B2` を `A1, B1, A2, B2` として展開することを確認。
  - 実際に `DISCRETE(A1:B2)` を評価し、エラーにならないことを確認（モックの `ctx.getValue` を使用）。

### 手動検証

1.  アプリを起動。
2.  グリッド上で `A1`=10, `B1`=0.5, `A2`=20, `B2`=0.5 を入力。
3.  `C1` に `=DISCRETE(A1:B2)` を入力。
4.  結果が正しく計算される（10 と 20 が半々の確率）ことを確認。
